# Product Requirements Document (PRD): Bundle Quoter App

## 1. Background & Rationale

Sales frequently needs to quote **composite packages** (bundles) of Omron products. Currently, bundle logic is fragmented across two Streamlit apps:
- **Product Association App**: Defines parent and dependent product groupings with mapping types (“Objective/Subjective”) and multiples, plus analytics and exports.
- **Quote Automater App**: Authenticates to Addlify, selects company/contact, sets quote metadata, chooses models, and pushes line items into a quote.

**Bundle Quoter** unifies these: define bundles once, store them in a centralized Google Sheet, and generate quotes directly from bundle selections. This moves the project to a more robust, multi-user data store.

---

## 2. Goals & Non‑Goals
**Goals**
- Rapid creation of **bundles** comprising selected models with parent–dependent associations.
- Persist all **new** bundles into **a Google Sheet**; support loading and editing existing bundles.
- **Quote** generation in Addlify from selected bundles (company/contact selection; line items created automatically).
- Reuse existing **grouping, mapping, and calculation** capabilities and existing **quote pipeline**.
- Provide **auditable** bundle definitions (created by, timestamps) and simple versioning.
- Support **multiple users**, allowing each user to manage their own bundles, with authentication tied to their Addlify login.
- **Log user activity**, including login timestamps and frequency.
- **Log all generated quotes** with a link to the quote, the bundle used, and its value.
- Special privileges for designated users, including access to logs and the ability to create "Promotion" bundles.

**Non‑Goals**
- Replace Addlify’s end-to-end quoting experience.
- Complex pricing rules (beyond per-line item price & quantity).
- A complex role-based access control system beyond the defined special user privileges.

---

## 3. Users & Use Cases

**Primary users**: Sales engineers, BDMs, PMMs, and inside sales.
**Special users**: Designated administrators with additional privileges.

**Key use cases**
1. **Create bundle**: Choose parent group, add dependents, set multiples/quantities; save bundle to the user's private collection in Google Sheets.
2. **Create Promotion Bundle (Special Users only)**: Create a bundle and flag it as a "Promotion".
3. **Manage my bundles**: Search/load the user's existing bundles, modify, and re-save; deprecate with a flag.
4. **Browse all bundles**: Users can view bundles created by others, but cannot edit or delete them.
5. **Browse Promotion Bundles**: Users can view all bundles flagged as "Promotion" in a dedicated section.
6. **Generate quote from bundle(s)**: Pick company/contact, title, expiry; select bundles; optionally override price/qty; push to Addlify; get public quote link.
7. **Export/inspect**: Download bundle definitions and analytics.
8. **Review user logins (Special Users only)**: View a log of user login activity.
9. **Review quote history (Special Users only)**: View a log of all quotes generated by the app.

---

## 4. Product Scope & Features

### 4.1 Bundle Builder (Streamlit page/tab)
- **Model/Group selection**: Parent and dependent group inputs, mapping type (Objective/Subjective), multiple, quantity per dependent.
- **Bundle details**: Name, description, tags, created_by, created_at.
- **Promotion Bundle (Special Users only)**: A checkbox to mark the bundle as a "Promotion" bundle.
- **Add/remove items**: Unlimited dependents; parent may be one or many models.
- **Validation**: Ensure model IDs exist in the models list loaded by quoting code.
- **Persist**: Save as a row-per-line-item in a Google Sheet, associated with the current user. Append only for new bundles; edits create a new revision row.

### 4.2 My Bundles (Streamlit page/tab)
- Filter/search the current user's bundles by bundle_name, tag, active/deprecated.
- The bundle description will be visible in the main table.
- Load existing bundle → prefill the Builder controls for editing (creates a new revision).
- Delete bundles owned by the user.
- Button to "Go to Quote Page with this Bundle".

### 4.3 All Bundles (Streamlit page/tab)
- Filter/search all bundles from all users.
- The bundle description will be visible in the main table.
- View bundles in a read-only mode.
- Button to "Go to Quote Page with this Bundle".

### 4.4 Promotion Bundles (Streamlit page/tab)
- Display a table of all bundles with `bundle_type` as "Promotion".
- View bundles in a read-only mode.
- Button to "Go to Quote Page with this Bundle".

### 4.5 Quote Page
- **Login** to Addlify (sidebar) using existing login flow and session state.
- **Company & contact selection**: Reuse company/contact selection logic.
- **Quote metadata**: Title, expiry date, optional notes.
- **Choose bundles**: Multiselect bundles, show their items; allow per-item overrides (price, qty, min_qty).
- **Create quote**: Reuse quote creation pipeline; add each bundle line and display public URL.
- **Error summary**: Provide a downloadable Excel log for failed line items.

### 4.6 User Login Log (Streamlit page/tab, Special Users only)
- Display a table of user login activity.
- Columns: User ID, Last Login, Login Count.

### 4.7 Quote Log (Streamlit page/tab, Special Users only)
- Display a table of all generated quotes.
- Columns: Timestamp, User ID, Bundle Name, Total Value, Addlify Quote URL.

---

## 5. Data Model & Google Sheets Schema

The data will be stored in a single Google Sheet with multiple tabs (worksheets).

### 5.1 `bundles` worksheet

| Column               | Type      | Notes                                                      |
|----------------------|-----------|------------------------------------------------------------|
| bundle_id            | string    | UUIDv4 for the bundle revision                             |
| bundle_name          | string    | Human-friendly name                                        |
| bundle_version       | int       | Incremented per edit (start at 1)                          |
| bundle_type          | string    | "Standard" or "Promotion"                                  |
| status               | enum      | `active` / `deprecated`                                    |
| parent_model_id      | string    | Optional: parent model’s ID; or use group name             |
| parent_group_name    | string    | If using groups from association UI                        |
| dependent_model_id   | string    | Model ID for dependent line                                |
| dependent_group_name | string    | Optional grouping label                                    |
| mapping_type         | enum      | `Objective` / `Subjective`                                 |
| multiple             | float     | Multiplier from association UI                             |
| quantity             | int       | Default quantity for this dependent in the bundle          |
| min_quantity         | int       | Minimum allowed quantity                                   |
| price_override       | float     | Optional default price override                            |
| notes                | string    | Free text (used for Description)                           |
| created_by           | string    | e.g., user email                                           |
| created_at           | ISO datetime |                                                          |
| source_model_json    | string    | Path/hash of models JSON used                              |
| user_id              | string    | Identifier for the user who owns the bundle                |

### 5.2 `user_stats` worksheet

| Column       | Type         | Notes                            |
|--------------|--------------|----------------------------------|
| user_id      | string       | Unique identifier for the user   |
| last_login   | ISO datetime | Timestamp of the user's last login |
| login_count  | int          | Total number of logins           |

### 5.3 `quote_log` worksheet

| Column         | Type         | Notes                               |
|----------------|--------------|-------------------------------------|
| timestamp      | ISO datetime | When the quote was created          |
| user_id        | string       | User who created the quote          |
| bundle_name    | string       | Name of the bundle quoted           |
| total_value    | float        | The total value of the quote        |
| quote_url      | string       | URL of the quote on Addlify         |

---

## 6. Architecture & Integration

**Pages**
1. **Bundle Builder** (build/edit; saves to Google Sheet)
2. **My Bundles** (search/load user's bundles)
3. **All Bundles** (browse all bundles)
4. **Promotion Bundles** (browse promotion bundles)
5. **Quote** (select company/contact, generate quote)
6. **User Login Log** (view user activity, special users only)
7. **Quote Log** (view quote history, special users only)

**Modules**
- `association_utils.py`: Extract reusable helpers from product association app.
- `quoting_utils.py`: Extract Addlify-facing helpers from quote automater app.
- `bundle_store.py`: Read/write to Google Sheets, dedupe, fetch latest version per bundle_name.
- `streamlit_gsheets`: Used for connecting to and interacting with Google Sheets.

**Flow**
- A user is identified by their Addlify login email.
- On app start, user login is logged to the `user_stats` sheet.
- Builder uses association utils to create logical parent–dependent mappings and validate multiples.
- Builder writes the final normalized bundle rows via bundle_store to the `bundles` sheet.
- Quote page:
  1. Login & preload companies/models.
  2. Load selected bundle(s) from the `bundles` sheet.
  3. Transform to Addlify line-item payloads.
  4. Create quote → add items → display URL.
  5. Log the quote details to the `quote_log` sheet.

---

## 7. UI/UX Requirements

- **Consistent Streamlit nav**: Sidebar radio with pages; reuse login section from quoting app.
- **Builder controls**: Parent group expanders, dependent group expanders with Objective/Subjective checkboxes and Multiple numeric inputs.
- **Quote page**: Company and contact select boxes, bundle multiselect, items preview table with editable price/qty/min_qty per line.
- **New Tabs**: Add new tabs for "User Login Log" and "Quote Log" with simple tables to display the data, visible only to special users.
- **Promotion Bundles Tab**: A new tab to display promotion bundles.

---

## 8. Functional Requirements

1. **Create bundles**  
   - Input: parent(s), dependent(s), mapping_type, multiple, default quantity & min_quantity, optional price_override.  
   - Output: append rows to `bundles` worksheet with bundle_version incremented if name matches an existing bundle. Associate bundle with the current user.
   - Special users can mark a bundle as "Promotion".

2. **Load bundles**  
   - "My Bundles" shows the latest bundle_version per bundle_name for the current user.
   - "All Bundles" shows the latest bundle_version per bundle_name for all users in a read-only view.
   - "Promotion Bundles" shows all bundles marked as "Promotion".

3. **Quote generation**  
   - Require Addlify login; choose company & contact; set title and expiry; push line items generated from the bundle(s).
   - Log the generated quote's details to the `quote_log` worksheet.

4. **User Login Tracking**
   - On app load, identify the user via Addlify login.
   - Update the `user_stats` worksheet with the current login time and increment the login count for that user.

5. **Error handling**  
   - Display failed line items and offer an Excel download of errors.

6. **Model validation**  
   - Bundle Builder must validate selected model IDs exist in the flattened models list.

---